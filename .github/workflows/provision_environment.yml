name: Provision Environment on Issue Open
on:
  issues:
    types: [opened]

jobs:
  provision:
    runs-on: ubuntu-latest

    steps:
      - name: Check if issue is an environment request
        if: contains(github.event.issue.labels.*.name, 'environment-request')
        run: echo "Environment request detected"
      
      - name: Set up Azure CLI with Azure Login v2
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Parse Issue Body for Details
        id: parse_issue
        run: |
          echo "app_name=$(echo "${{ github.event.issue.body }}" | grep 'app_name' | cut -d ':' -f2 | xargs)" >> $GITHUB_ENV
          echo "region=$(echo "${{ github.event.issue.body }}" | grep 'Region' | cut -d ':' -f2 | xargs)" >> $GITHUB_ENV
          echo "instance_type=$(echo "${{ github.event.issue.body }}" | grep 'Instance Type' | cut -d ':' -f2 | xargs)" >> $GITHUB_ENV

      - name: Create Resource Group (if needed)
        run: |
          az group create --name "${{ env.app_name }}-rg" --location "${{ env.region }}"
        continue-on-error: true

      - name: Deploy Application Infrastructure
        env:
          APP_NAME: ${{ env.app_name }}
          REGION: ${{ env.region }}
          INSTANCE_TYPE: ${{ env.instance_type }}
        run: |
          az deployment group create --resource-group "${{ env.app_name }}-rg" \
          --template-file your-template-file.json \
          --parameters location=${{ env.region }} instanceType=${{ env.instance_type }}

      - name: Get Application URL
        id: get_app_url
        run: |
          APP_URL=$(az webapp show --name "${{ env.app_name }}" --resource-group "${{ env.app_name }}-rg" --query defaultHostName -o tsv)
          echo "APP_URL=${APP_URL}" >> $GITHUB_ENV
      
      - name: Comment on Issue with Environment Details
        run: |
          curl -s -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -d '{"body": "Environment for `${{ env.app_name }}` is ready! Access it [here](http://${{ env.APP_URL }})"}' \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments"
